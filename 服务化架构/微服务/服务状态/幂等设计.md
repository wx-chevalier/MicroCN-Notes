# 幂等设计

如今我们的系统大多拆分为分布式 SOA，或者微服务，一套系统中包含了多个子系统服务，而一个子系统服务往往会去调用另一个服务，而服务调用服务无非就是使用 RPC 通信或者 restful，既然是通信，那么就有可能再服务器处理完毕后返回结果的时候挂掉，这个时候用户端发现很久没有反应，那么就会多次点击按钮，这样请求有多次，那么处理数据的结果就有可能不一致问题。

一个幂等操作的特点是其任意多次执行所产生的影响均与一次执行的影响相同。幂等函数，或幂等方法，是指可以使用相同参数重复执行，并能获得相同结果的函数。这些函数不会影响系统状态，也不用担心重复执行会对系统造成改变。针对一个操作，不管做多少次，产生效果或返回的结果都是一样的。

# CURD 与幂等

从读写层面来说，写请求有可能会对数据造成改变；从分层架构层面来说，数据访问层（DAO 层）可能会对数据造成改变。因此幂等设计重点考虑数据访问层的写请求。

- 查询对于结果是不会有改变的（无）

- 删除操作需要根据 sql 语句来定义（绝对值的修改是幂等的比如 delete from user where age=10，相对值的修改不是幂等的比如 delete from user bottom 10）

- 更新操作需要根据 sql 语句来定义（比如 update user set age=10 where uid=20（绝对值修改）是幂等的，而 update user set age++ where uid=20（相对值的修改）是非幂等的）

- insert 基本上不是幂等,除非表设计了一些约束（比如唯一主键等）

要实现幂等技术就是要在数据服务层保证幂等。

- 数据表使用唯一主键（unique）或者联合主键保证
- token 机制（redis+token）：数据提交前要向服务的申请 token，token 放到 redis，token 有效时间；提交后后台校验 token，同时删除 token，完成相关业务逻辑。
- 通过数据库悲观锁和乐观锁机制
- 分布式锁
- 根据业务进行状态机幂等设计

# API 接口层幂等

如银联提供的付款接口：需要接入商户提交付款请求时附带：source 来源，seq 序列号。source+seq 在数据库里面做唯一索引，防止多次付款。

对外提供接口为了支持幂等调用，接口有两个字段必须传，一个是来源 source，一个是来源方序列号 seq，这个两个字段在提供方系统里面做联合唯一索引，这样当第三方调用时，先在本方系统里面查询一下，是否已经处理过，返回相应处理结果；没有处理过，进行相应处理，返回结果。注意，为了幂等友好，一定要先查询一下，是否处理过该笔业务，不查询直接插入业务系统，会报错，但实际已经处理了。
